name: Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+*"   # e.g. 1.0.0-beta07, 2.0.0

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

env:
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dkotlin.incremental=false

permissions:
  contents: write   # create releases & upload assets

jobs:
  build:
    runs-on: macos-latest          # needed for iOS klibs (Kotlin/Native)
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Cache Kotlin/Native compiler
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: konan-${{ runner.os }}-${{ hashFiles('**/*.gradle.kts', 'gradle/libs.versions.toml') }}
          restore-keys: konan-${{ runner.os }}-

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Publish to local staging
        run: |
          ./gradlew :lumen:publishAllPublicationsToLocalStagingRepository \
            -Psigning.gnupg.keyName=${{ secrets.GPG_KEY_ID }} \
            -Psigning.gnupg.passphrase=${{ secrets.GPG_PASSPHRASE }}

      - name: Verify publications
        run: |
          EXPECTED=7
          ACTUAL=$(find lumen/build/staging-deploy -mindepth 3 -maxdepth 3 -type d | wc -l | tr -d ' ')
          echo "Found $ACTUAL publications (expected $EXPECTED)"
          if [ "$ACTUAL" -ne "$EXPECTED" ]; then
            echo "::error::Expected $EXPECTED publications but found $ACTUAL"
            exit 1
          fi

      - name: Create bundle zip
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          cd lumen/build/staging-deploy
          zip -r "$GITHUB_WORKSPACE/lumen-${TAG}-bundle.zip" io/

      - name: Extract changelog
        id: changelog
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Extract section between this version header and the next
          awk "/^## \[${TAG}\]/{found=1; next} /^## \[/{if(found) exit} found{print}" CHANGELOG.md > release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "No changelog entry found for ${TAG}, using default"
            echo "Release ${TAG}" > release_notes.md
          fi

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          gh release create "$TAG" \
            "lumen-${TAG}-bundle.zip" \
            --title "$TAG" \
            --notes-file release_notes.md \
            --prerelease
